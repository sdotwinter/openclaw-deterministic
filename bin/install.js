#!/usr/bin/env node

const fs = require("fs");
const os = require("os");
const path = require("path");
const readline = require("readline");

const command = process.argv[2];

if (!command) {
  showHelp();
  process.exit(0);
}

if (command === "doctor") {
  runDoctor(false);
} else if (command === "install") {
  runInstall();
} else if (command === "--version" || command === "-v") {
  console.log("openclaw-deterministic v0.1.0");
  process.exit(0);
} else {
  console.error(`Unknown command: ${command}\n`);
  showHelp();
  process.exit(1);
}

function showHelp() {
  console.log("OpenClaw Deterministic CLI\n");
  console.log("Usage:");
  console.log("  oc-deterministic doctor");
  console.log("  oc-deterministic install");
  console.log("  oc-deterministic --version\n");
}

function getPaths() {
  const homeDir = os.homedir();
  const openclawDir = path.join(homeDir, ".openclaw");
  const workspacePath = path.join(openclawDir, "workspace");

  return { openclawDir, workspacePath };
}

function runDoctor(silent = false) {
  const { openclawDir, workspacePath } = getPaths();

  if (!fs.existsSync(openclawDir)) {
    if (!silent) {
      console.error("❌ OpenClaw not detected.");
      console.error(`Expected directory: ${openclawDir}`);
    }
    return { fatal: true };
  }

  if (!fs.existsSync(workspacePath)) {
    if (!silent) {
      console.error("⚠️ OpenClaw detected but workspace missing.");
      console.error(`Expected workspace at: ${workspacePath}`);
    }
    return { fatal: true };
  }

  const checks = [
    { label: "memory/", path: path.join(workspacePath, "memory"), type: "dir" },
    { label: "memory/working/", path: path.join(workspacePath, "memory", "working"), type: "dir" },
    { label: "memory/episodic/", path: path.join(workspacePath, "memory", "episodic"), type: "dir" },
    { label: "memory/semantic/", path: path.join(workspacePath, "memory", "semantic"), type: "dir" },
    { label: "skills/", path: path.join(workspacePath, "skills"), type: "dir" },
    { label: "skills/memory-compactor/", path: path.join(workspacePath, "skills", "memory-compactor"), type: "dir" },
    { label: "OPERATING_RULES.md", path: path.join(workspacePath, "OPERATING_RULES.md"), type: "file" }
  ];

  const missing = [];

  checks.forEach(item => {
    if (!fs.existsSync(item.path)) {
      missing.push(item);
    }
  });

  if (!silent) {
    console.log("Workspace validation report:\n");
    checks.forEach(item => {
      if (fs.existsSync(item.path)) {
        console.log(`✔ ${item.label}`);
      } else {
        console.log(`✖ ${item.label} (missing)`);
      }
    });
    console.log("");
  }

  return {
    fatal: false,
    missing,
    workspacePath
  };
}

function runInstall() {
  console.log("Running install phase...\n");

  const result = runDoctor(true);

  if (result.fatal) {
    console.error("Cannot install. OpenClaw workspace not valid.");
    process.exit(1);
  }

  if (result.missing.length === 0) {
    console.log("✅ Workspace already fully configured.");
    process.exit(0);
  }

  console.log("The following items are missing and will be created:\n");
  result.missing.forEach(item => {
    console.log(`• ${item.label}`);
  });

  console.log("");

  confirmAction("Proceed with installation? (y/n): ", answer => {
    if (answer.toLowerCase() !== "y") {
      console.log("Install aborted.");
      process.exit(0);
    }

    result.missing.forEach(item => {
      if (item.type === "dir") {
        fs.mkdirSync(item.path, { recursive: true });
      } else if (item.type === "file") {
        fs.writeFileSync(item.path, "# OPERATING_RULES\n\nGenerated by openclaw-deterministic.\n");
      }
    });

    console.log("\n✅ Installation complete.");
    process.exit(0);
  });
}

function confirmAction(question, callback) {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  rl.question(question, answer => {
    rl.close();
    callback(answer);
  });
}
